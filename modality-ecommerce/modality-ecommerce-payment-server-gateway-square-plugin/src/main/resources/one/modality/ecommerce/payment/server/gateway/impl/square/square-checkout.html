<!doctype html>
<html>
<head>
<!--
    <link href="/app.css" rel="stylesheet" />
-->
    <script
            type="text/javascript"
            src="${square_webPaymentsSDKUrl}" />
    ></script>
    <script>
        console.log("Starting Square script");
        // Parameters injected by SquarePaymentGateway java class on server-side
        const square_appId = '${square_appId}';
        const square_locationId = '${square_locationId}';
        const modality_paymentId = '${modality_paymentId}';
        const square_idempotencyKey = window.crypto.randomUUID();
        const modality_amount = ${modality_amount};
        const modality_currencyCode = "${modality_currencyCode}";
        const modality_completePaymentRoute = "${modality_completePaymentRoute}";

        // Parameter injected by WebPaymentForm java class on client-side (to allow JS -> Java callbacks)
        let modality_javaPaymentForm;

        let inited;
        let initError;
        let initNotificationCalled;

        let card;
        let payments;

        async function initializeCard(payments) {
            const card = await payments.card();
            await card.attach('#card-container');

            return card;
        }

        async function createPayment(square_sourceId, square_verificationToken) {
            const body = JSON.stringify({
                modality_paymentId: modality_paymentId,
                modality_amount: modality_amount,
                modality_currencyCode: modality_currencyCode,
                square_locationId : square_locationId,
                square_sourceId: square_sourceId,
                square_verificationToken: square_verificationToken,
                square_idempotencyKey: square_idempotencyKey,
            });

            // Calling the Modality server to complete the payment (will call Square to make the actual final payment)
            const paymentResponse = await fetch(modality_completePaymentRoute, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body,
            });

            const text = await paymentResponse.text();
            if (!paymentResponse.ok) {
                throw new Error(text);
            } else {
                let status = text.toUpperCase();
                if (status === "APPROVED" || status === "PENDING" || status === "COMPLETED" || status === "CANCELED" || status === "FAILED") {
                    return status;
                } else {
                    throw new Error(text);
                }
            }
        }

        async function tokenize(paymentMethod) {
            const tokenResult = await paymentMethod.tokenize();
            if (tokenResult.status === 'OK') {
                return tokenResult.token;
            } else {
                let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
                if (tokenResult.errors) {
                    errorMessage += ` and errors: ${JSON.stringify(
                        tokenResult.errors,
                    )}`;
                }

                throw new Error(errorMessage);
            }
        }

        // Required in SCA Mandated Regions: Learn more at https://developer.squareup.com/docs/sca-overview
        async function verifyBuyer(token, firstName, lastName, email, phone, address, city, state, countryCode) {
            if (email)
                email = email.toLowerCase();
            if (countryCode)
                countryCode = countryCode.toUpperCase(); // Square rejects lower case country codes
            const verificationDetails = {
                amount: (Number(modality_amount) / 100).toFixed(2),
                billingContact: {
                    givenName: firstName,
                    familyName: lastName,
                    email: email,
                    phone: phone,
                    addressLines: [address],
                    city: city,
                    state: state,
                    countryCode: countryCode,
                },
                currencyCode: modality_currencyCode,
                intent: 'CHARGE',
            };

            const verificationResults = await payments.verifyBuyer(
                token,
                verificationDetails,
            );
            return verificationResults.token;
        }

        // status is either SUCCESS or FAILURE;
        function displayPaymentResults(status) {
            const statusContainer = document.getElementById(
                'payment-status-container',
            );
            if (status === 'SUCCESS') {
                statusContainer.classList.remove('is-failure');
                statusContainer.classList.add('is-success');
            } else {
                statusContainer.classList.remove('is-success');
                statusContainer.classList.add('is-failure');
            }

            statusContainer.style.visibility = 'visible';
        }

        async function onLoaded() {
            console.log("Square DOMContentLoaded");
            if (modality_javaPaymentForm) {
                console.log("modality_javaPaymentForm is set");
            } else {
                console.log("modality_javaPaymentForm is NOT set");
            }

            if (!window.Square) {
                modality_notifyInitFailure('Square.js failed to load properly');
                return;
            }

            try {
                console.log("Calling payments");
                payments = window.Square.payments(square_appId, square_locationId);
            } catch (e) {
                console.error('Payments failed', e);
                modality_notifyInitFailure('Square payments failed to initialize')
                const statusContainer = document.getElementById(
                    'payment-status-container',
                );
                statusContainer.className = 'missing-credentials';
                statusContainer.style.visibility = 'visible';
                return;
            }

            try {
                console.log("Calling initializeCard");
                card = await initializeCard(payments);
            } catch (e) {
                console.error('Initializing Card failed', e);
                modality_notifyInitFailure('Square card initialization failed')
                return;
            }

            modality_notifyInitSuccess();
        }

        async function handlePaymentMethodSubmission(firstName, lastName, email, phone, address, city, state, countryCode) {
            // Firstly: Card number verification
            let token;
            try {
                token = await tokenize(card);
            } catch (e) {
                displayPaymentResults('FAILURE');
                console.error(e.message);
                modality_notifyGatewayRecoveredFailure(e.message);
                return;
            }

            // Secondly: Buyer verification
            let verificationToken;
            try {
                verificationToken = await verifyBuyer(token, firstName, lastName, email, phone, address, city, state, countryCode);
            } catch (e) {
                displayPaymentResults('FAILURE');
                console.error(e.message);
                modality_notifyGatewayFailure(e.message);
                return;
            }

            // Thirdly: Modality server process (includes Square payment completion + Modality payment database update)
            try {
                const paymentStatus = await createPayment(
                    token,
                    verificationToken,
                );
                displayPaymentResults('SUCCESS');

                console.debug('Payment Success', paymentStatus);
                modality_notifyFinalStatus(paymentStatus);
            } catch (e) {
                displayPaymentResults('FAILURE');
                console.error(e.message);
                modality_notifyModalityFailure(e.message);
            }
        }

        if (document.readyState === "complete" || document.readyState === "interactive") {
            // Document is already ready, so just call the function directly
            onLoaded();
        } else {
            // Document is not ready yet, so add an event listener for DOMContentLoaded
            document.addEventListener('DOMContentLoaded', onLoaded);
        }

        // Methods called by WebPaymentForm java class on client-side

        function modality_injectJavaPaymentForm(jpf) {
            console.log("modality_injectJavaPaymentForm() called");
            modality_javaPaymentForm = jpf;
            if (inited) {
                if (initError)
                    modality_notifyInitFailure(initError);
                else
                    modality_notifyInitSuccess();
            }
        }

        function modality_submitGatewayPayment(firstName, lastName, email, phone, address, city, state, countryCode) {
            console.log("modality_submitGatewayPayment() called");
            handlePaymentMethodSubmission(firstName, lastName, email, phone, address, city, state, countryCode);
        }

        // Methods called by this JS script to call back the Java WebPaymentForm class

        function modality_notifyInitSuccess() {
            inited = true;
            if (modality_javaPaymentForm) {
                modality_javaPaymentForm.onInitSuccess();
                initNotificationCalled = true;
            }
        }

        function modality_notifyInitFailure(error) {
            inited = true;
            if (modality_javaPaymentForm) {
                modality_javaPaymentForm.onInitFailure(error);
                initNotificationCalled = true;
            }
        }

        function modality_notifyGatewayRecoveredFailure(error) {
            if (modality_javaPaymentForm)
                modality_javaPaymentForm.onGatewayRecoveredFailure(error);
        }

        function modality_notifyGatewayFailure(error) {
            if (modality_javaPaymentForm)
                modality_javaPaymentForm.onGatewayFailure(error);
        }

        function modality_notifyModalityFailure(error) {
            if (modality_javaPaymentForm)
                modality_javaPaymentForm.onModalityFailure(error);
        }

        function modality_notifyFinalStatus(status) {
            if (modality_javaPaymentForm)
                modality_javaPaymentForm.onFinalStatus(status);
        }

    </script>
</head>
<body>
<form id="payment-form">
    <div id="card-container"></div>
</form>
<div id="payment-status-container"></div>
</body>
</html>
